# Fix Database Schema Drift on Deploy

## Problem Statement

Schema drift occurs between staging/production and the codebase because:

1. **No migration step in CI/CD**: The deploy workflow deploys code but never runs `alembic upgrade head`
2. **`init_db()` bypasses Alembic**: The app startup uses `Base.metadata.create_all()` which creates tables directly from models, ignoring migration history
3. **Test isolation**: Tests run against a fresh database with all migrations applied, but staging/production may have an older schema

**Specific issue mentioned**: Tests pass locally because they run against a database with the `i9d0e1f2g3h4` migration (agent_id nullable), but staging had the old schema where agent_id was NOT NULL.

## Root Causes

### 1. Deployment Pipeline Missing Migration Step
```yaml
# Current deploy.yml - NO migration step
- name: Build
  run: cd platform && bun run build
- name: Deploy to Vercel
  uses: amondnet/vercel-action@v25
```

### 2. `init_db()` Creates Tables Without Alembic
```python
# database.py - bypasses migrations entirely
async def init_db() -> None:
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)  # PROBLEM!
```

### 3. No Schema Verification
- No check that deployed code matches database schema version
- No warning when schema is out of sync

## Solution Design

### Phase 1: Add Migration Step to Deployment
- Add `alembic upgrade head` to GitHub Actions workflow
- Requires backend Python environment setup in CI

### Phase 2: Remove `create_all()` from Production
- Modify `init_db()` to NOT create tables in production
- Only allow `create_all()` in test environments
- Production relies exclusively on Alembic migrations

### Phase 3: Add Schema Version Verification
- Add health endpoint that verifies current Alembic head matches expected
- Fail fast if schema is out of sync

### Phase 4: Improve Migration Reliability
- Ensure all migrations are idempotent
- Add pre-deployment migration dry-run

## Implementation Plan

### Step 1: Modify database.py to guard `create_all()`
- Only run `create_all()` when TESTING=true
- Log warning if ENVIRONMENT=production

### Step 2: Update deploy.yml with migration step
- Set up Python in CI
- Install backend dependencies
- Run `alembic upgrade head` before Vercel deploy

### Step 3: Add schema verification to health check
- Create function to compare current Alembic version with expected
- Add to `/health` endpoint

### Step 4: Update CI to run migration dry-run
- Add step to check migrations would apply cleanly

## Status

- [x] Phase 1: Add migration step to deployment
- [x] Phase 2: Guard `create_all()` in production
- [x] Phase 3: Add schema verification
- [x] Phase 4: Migration dry-run in CI

## Changes Made

### 1. `platform/backend/db/database.py`
- Added `_get_latest_migration_from_files()` to **auto-detect** the head migration
- `EXPECTED_MIGRATION_HEAD` is now computed automatically - no manual updates needed
- Added `get_current_migration_version()` to query alembic_version table
- Added `verify_schema_version()` to compare current vs expected version
- Modified `init_db()` to:
  - Only run `create_all()` in test mode (`TESTING=true`)
  - Skip `create_all()` in production (rely on Alembic)
  - Log warning in development mode

### 2. `.github/workflows/deploy.yml`
- Added Python setup step
- Added backend dependencies installation
- Added `alembic upgrade head` step **before** deployment
- This ensures database schema is updated before new code goes live

### 3. `platform/backend/main.py`
- Updated `/health` endpoint to include schema verification
- Returns `status: "degraded"` if schema drift detected
- Includes `schema` object with version details

### 4. `.github/workflows/review.yml`
- Replaced `init_db()` with proper Alembic migration
- Added check for pending model changes (dry-run autogenerate)
- Fails if models have changes not captured in migrations

## Maintenance Notes

**When adding new migrations:**
1. Create migration: `alembic revision --autogenerate -m "description"`
2. Review and commit the migration file
3. That's it! `EXPECTED_MIGRATION_HEAD` auto-detects from files
