# Voice-Driven Generative UI

**Plan source:** `~/.claude/plans/zippy-dreaming-turing.md`
**Branch:** `feat/voice-genui`
**Worktree:** `../deep-sci-fi-voice/`
**Created:** 2026-02-05

## Phases

- [x] Phase 0: Worktree setup
- [x] Phase 1: Agent + Generative UI (text input, no voice)
- [x] Phase 2: Voice Input (push-to-talk + STT)
- [x] Phase 3: Voice Output (TTS)
- [x] Phase 4: Full Component Catalog
- [ ] Phase 5: Polish + Launch

## Phase 1 — Completed

### Backend Files Created
- `agent/__init__.py` — module exports
- `agent/state.py` — VoiceAgentState + UIPanel models
- `agent/tools.py` — search_worlds, get_world_detail, list_worlds (reuse SQLAlchemy queries)
- `agent/guide.py` — Pydantic AI agent with sci-fi narrator persona, Claude Sonnet 4.5
- `api/voice.py` — AG-UI SSE endpoint (`POST /api/voice/chat`)
- Router registered in `api/__init__.py` and `main.py`

### Frontend Files Created
- `hooks/useVoiceAgent.ts` — SSE consumer for AG-UI events, state management
- `components/voice/GenerativeUI.tsx` — Panel dispatcher (maps panel types to components)
- `components/voice/panels/VoiceWorldCard.tsx` — Detailed world card
- `components/voice/panels/VoiceWorldList.tsx` — World grid
- `components/voice/panels/VoiceCausalChain.tsx` — Timeline visualization
- `components/voice/ResponsePanel.tsx` — Streaming text display
- `components/voice/VoiceStatus.tsx` — Breadcrumbs + error display
- `components/voice/VoiceInterface.tsx` — Main orchestrator with text input
- `app/voice/layout.tsx` — Immersive layout (no header/footer)
- `app/voice/page.tsx` — Voice page
- `app/api/voice/agent/route.ts` — SSE proxy to FastAPI

### Dependencies Added
- `pydantic-ai-slim[ag-ui,anthropic]>=1.50.0` in requirements.txt

### Verification
- TypeScript typecheck: 0 new errors
- Python syntax: all files parse OK
- Backend imports: all modules import successfully
- Next.js build: compiles and builds `/voice` page (5.25 kB)

## Phase 2 — Completed

### Files Created
- `app/api/voice/transcribe/route.ts` — Deepgram Nova-2 STT proxy (HTTP POST)
- `hooks/useMediaRecorder.ts` — Push-to-talk recording hook (MediaRecorder + AudioContext analyser)
- `components/voice/PushToTalk.tsx` — PTT button with 4 visual states (idle/recording/processing/speaking)
- `components/voice/AudioVisualizer.tsx` — Canvas-based frequency bar visualizer

### Changes
- `VoiceInterface.tsx` — Replaced text form with PushToTalk (text input available via toggle)
- `globals.css` — Added `voice-pulse` keyframe animation
- Space bar shortcut for push-to-talk

### Env Vars Needed
- `DEEPGRAM_API_KEY` — for STT transcription

## Phase 3 — Completed

### Files Created
- `app/api/voice/tts/route.ts` — ElevenLabs TTS proxy (streaming audio/mpeg)
- `hooks/useTTS.ts` — TTS playback hook (Audio element + blob URL)

### Changes
- `VoiceInterface.tsx` — Auto-speak on stream completion, TTS interruption on new recording, Stop button in header

### Env Vars Needed
- `ELEVENLABS_API_KEY` — for text-to-speech
- `ELEVENLABS_VOICE_ID` — optional custom voice (defaults to "Rachel")

## Phase 4 — Completed

### Backend Tools Added (agent/tools.py)
- `get_stories(world_id)` → `story_list` panel
- `get_story_detail(story_id)` → `story_full` panel
- `get_dwellers(world_id)` → `dweller_list` panel
- `get_dweller_detail(dweller_id)` → `dweller_card` panel
- `get_activity(world_id)` → `activity_feed` panel
- `get_platform_stats()` → `search_results` panel (stats grid)

### Frontend Panels Created
- `panels/VoiceStoryList.tsx` — Story summary cards
- `panels/VoiceStoryFull.tsx` — Full story content
- `panels/VoiceDwellerCard.tsx` — Character detail with recent actions
- `panels/VoiceDwellerList.tsx` — Character grid
- `panels/VoiceActivityFeed.tsx` — Timeline of dweller actions
- `panels/VoicePlatformStats.tsx` — Platform overview stats grid

### Bug Fix
- Fixed `_dweller_summary()` — was using `d.persona.get("name")` but Dweller model has `d.name` directly

### Changes
- `guide.py` — Registered all 9 tools, updated system prompt with new tool behaviors
- `state.py` — Added `story_list` to UIPanel type literals
- `GenerativeUI.tsx` — Registered all 9 panel components

## Findings

- `pydantic-ai-slim` needs explicit `[anthropic]` extra for Claude provider
- `AGUIAdapter.dispatch_request()` is the simplest integration pattern
- `ToolReturn(metadata=[StateSnapshotEvent(...)])` pushes state to frontend via SSE
- AG-UI protocol version: 0.1.10
- Dweller model has direct `name`, `role`, `age` fields (not nested in `persona` JSONB)

## Instance Log

- Instance 1 (2026-02-05): Completed Phase 0 + Phase 1
- Instance 2 (2026-02-06): Completed Phase 2 + Phase 3 + Phase 4
