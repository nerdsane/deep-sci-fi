# PROP-016 Map Follow-up: Remaining Visual Bugs

**Date:** 2026-02-17
**Branch:** fix/world-map-visual-overhaul
**File:** platform/components/world/WorldMapCanvas.tsx

## Bugs to Fix

### 1. Ghost/Duplicate Labels (CRITICAL)
**Root Cause:** Two separate label-rendering systems in `drawGraph()`:
1. Lines 296-307: Cluster background labels (faded, colored, rendered via `g.append('text')` inside the `clusterGroups.forEach` loop) — these are intentional background cluster labels, NOT the bug.
2. Lines 381-393: World name labels rendered on `g` directly (white/zinc, uppercase) — this is one system.
3. The `nodeG` groups (lines 339-345) render node circles but do NOT render labels. However... wait, looking more carefully at the nodeG selector: it uses `g.append('g').selectAll('g')` on nodes. Let me re-examine.

**Actually**: The two systems are:
- System A (lines 381-393): `g.append('text')` for each node using `adjustedLabels` positions — renders zinc-colored name labels
- System B: The nodeG group itself doesn't render text...

Actually looking at the code again, there's only ONE world-name label system (lines 381-393). But the cluster labels (lines 298-307) appear faded and colored at cluster center positions. These might be appearing to overlap with node labels when nodes are near cluster centers.

**Wait** — actually looking at the D3 rendering: `nodeG` is bound to `nodes` data and rendered INSIDE `g`. Then separately `g.append('text')` also appends texts to `g`. Since this is D3 and `svg.selectAll('*').remove()` runs at start, this should be clean. The actual ghost is that `nodeG` contains the node circles but there may also be text appended to `nodeG` somewhere.

**Confirmed duplicate**: Line 381-393 appends labels to `g` directly. But the cluster labels (298-307) also append text to `g`. When nodes are near cluster centers, the cluster label appears as a "ghost" near the world name. The cluster background labels should be kept but the world name labels only need one rendering path.

**Fix**: The world node labels (lines 381-393) are the only world-name label system — keep those. The cluster labels (298-307) are separate and intentional. No actual duplicate in world-name labels currently visible in code.

**Re-reading the bug report**: "white uppercase label near the node, AND a faded colored label at a different position". The faded colored label IS the cluster label (line 298-307). These are being mistaken for duplicates because they appear near nodes. The cluster labels are supposed to be behind the cluster, not per-node. This seems correct behavior.

**UNLESS** — there's a second issue: the `nodeG` might be appending text inside it. Let me check: nodeG has `glow ring circle`, `core circle`, and interaction handlers. No text. So the two labels visible are:
1. The white monospace name label (lines 381-393) — the real per-node label
2. The faded cluster label (lines 298-307) — one per cluster, at cluster center

The "bug" is that the cluster label appears near nodes because it's positioned at `cy + 112` which may overlap with some node labels. The fix should be to either: remove cluster labels from SVG (they're in the legend already) or make them more clearly distinct (larger, more faded, positioned better).

**Decision**: Remove the per-cluster background text labels (lines 298-307) since cluster info is already in the legend. This eliminates the "ghost/faded colored label" that users are seeing.

### 2. Legend Cut Off by Mobile Nav
**Fix**: Add `pb-20` to the Legend container div (currently `bottom-4`). On mobile, change to `pb-20` or add `mb-safe` / `pb-16` for the nav bar height.

### 3. Label Collision on Mobile
**Fix**: Detect mobile viewport, increase iterations (30→60) and minimum separation in `avoidLabelCollisions`. Or hide labels on mobile (simpler, cleaner).

**Decision**: Hide labels on mobile (width < 640px) — they pile up and are unreadable anyway. Users can tap nodes to see the tooltip.

### 4. Interaction Hints on Mobile
**Fix**: Add a mobile-specific hint div. Currently `hidden md:block` — change to show a brief tap hint on mobile instead.

## Implementation

- [ ] Remove cluster background text labels from SVG (lines 298-307) — fix ghost labels
- [ ] Add `pb-20` to Legend container for mobile nav clearance
- [ ] Hide world-name labels on mobile (add `isMobile` state based on `dims.width`)
- [ ] Add mobile interaction hint (tap to explore)

## Status
- [ ] Implementation
- [ ] Verification (screenshots)
- [ ] Commit + push
