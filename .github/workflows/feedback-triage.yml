name: Feedback Triage

on:
  schedule:
    - cron: '0 9 * * *'  # Daily at 9am UTC
  workflow_dispatch:

jobs:
  triage:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Fetch feedback summary
        id: summary
        run: |
          curl -s --max-time 30 \
            "https://api.deep-sci-fi.world/api/feedback/summary" \
            -o /tmp/feedback-summary.json

          OPEN_COUNT=$(jq -r '.stats.open // 0' /tmp/feedback-summary.json)
          echo "open_count=$OPEN_COUNT" >> $GITHUB_OUTPUT
          echo "Found $OPEN_COUNT open feedback items"

      - name: Fetch open feedback list
        if: steps.summary.outputs.open_count != '0'
        run: |
          curl -s --max-time 30 \
            "https://api.deep-sci-fi.world/api/feedback/list?status=new&limit=100" \
            -o /tmp/feedback-list.json

      - name: Triage with Claude
        if: steps.summary.outputs.open_count != '0'
        id: triage
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are triaging agent feedback for the Deep Sci-Fi platform.

            ## Feedback Summary
            ```json
            $(cat /tmp/feedback-summary.json)
            ```

            ## Open Feedback Items
            ```json
            $(cat /tmp/feedback-list.json)
            ```

            ## Instructions

            Analyze the feedback and produce a triage report with these sections:

            ### Critical Issues (fix immediately)
            Items with severity "critical" or that block agents from functioning.

            ### Grouped Issues
            Group similar feedback items by root cause. For each group:
            - **Root cause**: What's actually wrong
            - **Affected items**: List feedback IDs
            - **Severity**: critical / high / medium / low
            - **Upvotes**: Total across group
            - **Suggested fix**: Concise description of what to change

            ### Priority Order
            Rank all groups by: critical severity first, then by upvote count descending, then by recency.

            ### Suggested Actions
            For each group, suggest a specific code change or investigation step.

            Output ONLY the markdown report, no preamble.

      - name: Create triage issue
        if: steps.summary.outputs.open_count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const today = new Date().toISOString().split('T')[0];
            const openCount = '${{ steps.summary.outputs.open_count }}';
            const triageReport = `${{ steps.triage.outputs.result }}`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Feedback Triage] ${today} — ${openCount} open items`,
              body: `## Automated Feedback Triage Report\n\n` +
                `**Date:** ${today}\n` +
                `**Open items:** ${openCount}\n\n` +
                `---\n\n` +
                triageReport + `\n\n` +
                `---\n\n` +
                `> To trigger an automated fix, add the \`approved-fix\` label to this issue.\n` +
                `> Claude will read this issue, implement the fix, and create a PR.\n\n` +
                `*Generated by [feedback-triage workflow](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID})*`,
              labels: ['feedback-triage']
            });

      - name: No open feedback
        if: steps.summary.outputs.open_count == '0'
        run: echo "No open feedback items — skipping triage"
