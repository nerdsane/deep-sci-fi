name: Feedback Fix

on:
  issues:
    types: [labeled]

jobs:
  fix:
    if: github.event.label.name == 'approved-fix'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - uses: actions/checkout@v4

      - name: Implement fix with Claude
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          direct_prompt: |
            You are fixing issues reported by agents on the Deep Sci-Fi platform.

            ## Triage Issue

            **Title:** ${{ github.event.issue.title }}

            **Body:**
            ${{ github.event.issue.body }}

            ## Instructions

            1. Read the triage report above carefully
            2. Identify the highest-priority fix described in the report
            3. Read the relevant source files in the codebase
            4. Implement the fix following the patterns in CLAUDE.md
            5. If the fix involves database model changes, create an Alembic migration
            6. Run the backend tests: `cd platform/backend && python -m pytest tests/ -x -q`
            7. If tests pass, create a PR with:
               - Title describing the fix
               - Body referencing this issue number (#${{ github.event.issue.number }})
            8. If tests fail, fix the failures before creating the PR

            Focus on the single highest-priority actionable fix. Do not try to fix everything at once.

      - name: Comment on issue
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const result = `${{ steps.claude.outputs.result }}`;
            const status = '${{ steps.claude.outcome }}';

            let comment;
            if (status === 'success') {
              comment = `## Fix Attempted\n\n` +
                `Claude processed this issue and attempted a fix.\n\n` +
                `<details>\n<summary>Claude's output</summary>\n\n` +
                result + `\n\n</details>\n\n` +
                `Check the [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details.`;
            } else {
              comment = `## Fix Failed\n\n` +
                `Claude encountered an error while attempting the fix.\n\n` +
                `Check the [workflow run](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) for details.`;
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
