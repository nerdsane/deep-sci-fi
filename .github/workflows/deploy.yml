name: Deploy

on:
  push:
    branches: [main, staging]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: pgvector/pgvector:pg15
        env:
          POSTGRES_USER: deepsci
          POSTGRES_PASSWORD: deepsci
          POSTGRES_DB: deepsci
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: platform/backend/requirements.txt

      - name: Install backend dependencies
        run: |
          cd platform/backend
          pip install -r requirements.txt
          pip install pytest pytest-asyncio hypothesis

      - name: Run DST (200 examples)
        run: |
          cd platform/backend
          pytest tests/simulation/ -v --tb=long --hypothesis-profile=ci -x
        env:
          TEST_DATABASE_URL: postgresql+asyncpg://deepsci:deepsci@localhost:5432/deepsci
          TESTING: "true"
          ADMIN_API_KEY: "test-admin-key"
          DEDUP_WINDOW_OVERRIDE_SECONDS: "0"
          DST_SIMULATION: "true"
        timeout-minutes: 15

  deploy:
    needs: [test]
    if: github.repository == 'rita-aga/deep-sci-fi'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # =========================================================================
      # Pre-flight: Check certificate expiry
      # =========================================================================
      - name: Check SSL certificate expiry
        run: |
          chmod +x scripts/check-cert-expiry.sh
          ./scripts/check-cert-expiry.sh 90

      # =========================================================================
      # Backend: Run Database Migrations
      # =========================================================================
      # CRITICAL: Migrations must run BEFORE code deployment to prevent schema drift.
      # The new code expects the new schema, so migrate first.

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: platform/backend/requirements.txt

      - name: Install backend dependencies
        run: |
          cd platform/backend
          pip install -r requirements.txt

      - name: Run database migrations
        run: |
          cd platform/backend
          echo "Current migration status:"
          alembic current
          echo ""
          echo "Running migrations..."
          alembic upgrade head
          echo ""
          echo "Migration complete. New status:"
          alembic current
        env:
          # Use staging DB for staging branch, production DB for main
          DATABASE_URL: ${{ github.ref == 'refs/heads/staging' && secrets.DATABASE_URL_STAGING || secrets.DATABASE_URL_PRODUCTION }}

      # =========================================================================
      # Frontend: Build and Deploy
      # =========================================================================

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: cd platform && bun install

      - name: Build
        run: cd platform && bun run build
        env:
          DATABASE_URL: ${{ github.ref == 'refs/heads/staging' && secrets.DATABASE_URL_STAGING || secrets.DATABASE_URL_PRODUCTION }}

      # Note: Vercel deployment is handled automatically via Vercel's GitHub integration.
      # This workflow focuses on running migrations before the code goes live.
