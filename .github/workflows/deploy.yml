# Deep Sci-Fi EC2 Deployment Workflow
# Deploys to EC2 instance via SSH on push to main

name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: 'Force rebuild all containers'
        required: false
        default: 'false'
        type: boolean

env:
  EC2_USER: ec2-user

jobs:
  deploy:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.EC2_HOST }}" ]; then
            echo "ERROR: EC2_HOST secret is not set"
            exit 1
          fi
          if [ -z "${{ secrets.EC2_SSH_KEY }}" ]; then
            echo "ERROR: EC2_SSH_KEY secret is not set"
            exit 1
          fi

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          FORCE_REBUILD: ${{ github.event.inputs.force_rebuild }}
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << 'ENDSSH'
            set -e
            cd ~/deep-sci-fi

            echo "=== Pulling latest code ==="
            git fetch origin main
            git reset --hard origin/main
            git submodule update --init --recursive

            echo "=== Checking for docker-compose.prod.yml ==="
            if [ ! -f "docker-compose.prod.yml" ]; then
              echo "ERROR: docker-compose.prod.yml not found"
              exit 1
            fi

            echo "=== Checking for .env file ==="
            if [ ! -f ".env" ]; then
              echo "WARNING: .env file not found. Creating from template..."
              if [ -f ".env.example" ]; then
                cp .env.example .env
                echo "Please configure .env with your API keys"
              fi
            fi

            echo "=== Building and deploying ==="
            if [ "$FORCE_REBUILD" = "true" ]; then
              docker compose -f docker-compose.prod.yml build --no-cache
            else
              docker compose -f docker-compose.prod.yml build
            fi

            docker compose -f docker-compose.prod.yml up -d

            echo "=== Cleaning up old images ==="
            docker system prune -f --volumes 2>/dev/null || true

            echo "=== Checking container status ==="
            docker compose -f docker-compose.prod.yml ps

            echo "=== Deployment complete ==="
          ENDSSH

      - name: Health Check
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Waiting for services to start..."
          sleep 45

          echo "Checking Letta Server health..."
          for i in {1..5}; do
            if curl -sf "http://$EC2_HOST:8283/v1/health" > /dev/null 2>&1; then
              echo "Letta Server is healthy!"
              break
            fi
            echo "Attempt $i failed, retrying in 10s..."
            sleep 10
          done

          echo "Checking Web App..."
          curl -sf "http://$EC2_HOST:3000" > /dev/null 2>&1 && echo "Web App is healthy!" || echo "Web App check failed (may still be starting)"

          echo "Checking Letta UI..."
          curl -sf "http://$EC2_HOST:4000" > /dev/null 2>&1 && echo "Letta UI is healthy!" || echo "Letta UI check failed (may still be starting)"

      - name: Post Deployment Summary
        if: always()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          DOMAIN: ${{ secrets.DOMAIN }}
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Service URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Web App**: http://$EC2_HOST:3000" >> $GITHUB_STEP_SUMMARY
          echo "- **Letta UI**: http://$EC2_HOST:4000" >> $GITHUB_STEP_SUMMARY
          echo "- **Letta API**: http://$EC2_HOST:8283" >> $GITHUB_STEP_SUMMARY
          echo "- **WebSocket**: ws://$EC2_HOST:8284" >> $GITHUB_STEP_SUMMARY
          if [ -n "$DOMAIN" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Custom Domain" >> $GITHUB_STEP_SUMMARY
            echo "- **Main**: https://$DOMAIN" >> $GITHUB_STEP_SUMMARY
            echo "- **Admin**: https://ui.$DOMAIN" >> $GITHUB_STEP_SUMMARY
          fi
