# Deep Sci-Fi Caddyfile
# Reverse proxy configuration with automatic SSL

# Global options
{
    # Email for Let's Encrypt (optional but recommended)
    # email admin@yourdomain.com

    # Uncomment for development/testing without real domain
    # auto_https off
}

# Main domain configuration
# Replace {$DOMAIN} with your actual domain, or use localhost for testing
{$DOMAIN:localhost} {
    # Logging
    log {
        output stdout
        format console
    }

    # API routes -> Letta Server
    handle /api/* {
        reverse_proxy letta-server:8283
    }

    handle /v1/* {
        reverse_proxy letta-server:8283
    }

    # WebSocket routes
    handle /ws/* {
        reverse_proxy websocket:8284
    }

    # Health check endpoint
    handle /health {
        respond "OK" 200
    }

    # Everything else -> Web App (Next.js)
    handle {
        reverse_proxy web-app:3000
    }
}

# Letta UI on subdomain or path
# Option 1: Subdomain (ui.yourdomain.com)
ui.{$DOMAIN:localhost} {
    reverse_proxy letta-ui:4000
}

# Option 2: Path-based (/admin) - uncomment if preferred
# handle /admin/* {
#     uri strip_prefix /admin
#     reverse_proxy letta-ui:4000
# }

# Direct service access (for development/debugging)
# Uncomment to enable direct port access through Caddy
# :8283 {
#     reverse_proxy letta-server:8283
# }
# :4000 {
#     reverse_proxy letta-ui:4000
# }
