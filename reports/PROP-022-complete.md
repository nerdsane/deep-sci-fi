# PROP-022: Materialize Relationships & Arcs — Complete

## Summary
Rewrote both PROP-009 (Dweller Relationships) and PROP-011 (Story Arcs) from compute-on-request to compute-on-write with materialized tables.

## What Changed (10 files, +1,332 / -381 lines)

### Migration 0023
- `platform_dweller_relationships` table: `dweller_a_id`, `dweller_b_id`, `co_occurrence_count`, `combined_score`, `shared_story_ids`
- Canonical ordering constraint (`dweller_a_id < dweller_b_id`) prevents duplicate pairs
- Indexes on both dweller columns + combined_score DESC

### Service Rewrites
- **relationship_service.py** — `update_relationships_for_story()` (upsert pairs on story write, score normalization) + `get_dweller_graph()` (read from table, zero computation)
- **arc_service.py** — `assign_story_to_arc()` (centroid cosine ≥ 0.75, NO time window) + `list_arcs()`/`get_story_arc()` read from table. `detect_arcs()` kept for admin/backfill.

### Post-Save Hooks
- `stories.py` — `_update_graph_and_arcs` background task fires after story creation. Per-phase sessions with explicit commit. Warning log on phase failure (non-blocking — story creation succeeds even if materialization fails).

### Tests (NEW — harness hook worked!)
- `test_relationships.py` (214 lines) — upserts, graph API, score normalization
- `test_arcs.py` (269 lines) — arc seeding, joining, splitting, no-time-window invariant

### Backfill Script
- `scripts/materialize_relationships_and_arcs.py` — idempotent, clears + recomputes all relationships and arcs from scratch

### Feed Pool Fix
- Reduced pool_size to stay within Neon session-mode connection limit (separate commit `daea47c`)

## Commit
`54781f9` on staging branch

## What's Missing
- Showboat doc wasn't generated by CC during the session (tool commands were in the prompt but CC skipped them)
- No Rodney screenshots (staging DB has minimal data)
- Backfill script not yet run against production
- This doc is a retroactive build by Haku
